#!/usr/bin/env ruby

require 'optparse'

env = ENV['MM_ENV'] || ENV['RACK_ENV'] || 'development'
options = { :Port => 4567, :Host => 'localhost', :AccessLog => [] }

OptionParser.new { |opts|
  opts.banner = "Usage: mm-server [rack options]"
  opts.separator ""
  opts.separator "Rack options:"
  opts.on("-p", "--port PORT", "use PORT (default: 4567)") { |port|
    options[:Port] = port
  }
  opts.on("-E", "--env ENVIRONMENT", "use ENVIRONMENT for defaults (default: development)") { |e|
    env = e
  }
  
  opts.parse! ARGV
}

ENV['RACK_ENV'] = env

# Require Middleman
require File.join(File.dirname(__FILE__), '..', 'lib', 'middleman')

class Middleman::Base
  set :root, Dir.pwd
  set :logging, false
end

require 'shotgun'
config = File.join(File.dirname(__FILE__), '..', 'lib', 'middleman', 'config.ru')
app = Shotgun.new(config, lambda { |inner_app| Middleman::Base.new })

require 'thin'
Thin::Logging.silent = true

Rack::Handler::Thin.run app, options do |inst|
  puts "== The Middleman is standing watch on port #{options[:Port]}"
end