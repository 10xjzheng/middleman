#!/usr/bin/env ruby

# Add our lib/ directory to the path
libdir = File.expand_path(File.join(File.dirname(File.dirname(__FILE__)), "lib"))
$LOAD_PATH.unshift(libdir) unless $LOAD_PATH.include?(libdir)

moredir = File.expand_path(File.join(File.dirname(File.dirname(libdir)), "middleman-more", "lib", "middleman-more"))
$LOAD_PATH.unshift(moredir) unless $LOAD_PATH.include?(moredir)

require "middleman-core/cli"

# Only look for config.rb if MM_ROOT isn't set
if !ENV["MM_ROOT"] && found_path = ::Middleman.locate_root
  ENV["MM_ROOT"] = found_path
end

# If we've found the root, try to setup Bundler
if ENV["MM_ROOT"]
  
  # Set up gems listed in the Gemfile.
  ENV['BUNDLE_GEMFILE'] ||= File.expand_path('Gemfile', ENV["MM_ROOT"])
  require 'bundler/setup' if File.exists?(ENV['BUNDLE_GEMFILE'])
end

# Automatically discover extensions in RubyGems
require "middleman-core/extensions"
::Middleman.load_extensions_in_path

# Default command is server
ARGV.unshift("server") if ARGV.length < 1 || ARGV.first.include?("-")

# Start the CLI
if ENV["MM_ROOT"]
  # Change directory to the root
  Dir.chdir(ENV["MM_ROOT"]) do
    Middleman::Cli::Base.start
  end
else
  Middleman::Cli::Base.start
end